<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Director Setup Portal</title>
  <link rel="stylesheet" href="/setup.css">
</head>
<body>
  <div class="setup-page">
    <!-- Background -->
    <div class="background-gradient"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>

    <!-- Main Container -->
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="logo-pill">
          <span class="logo-icon">üîê</span>
          <span class="logo-text">Setup Portal</span>
        </div>
        <h1 class="title">Director Account Setup</h1>
        <p class="subtitle">Create the main director account for the Lost & Found system</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="director">
          <span>üë®‚Äçüíº</span>
          <span>Create Director</span>
        </button>
        <button class="tab" data-tab="users">
          <span>üë•</span>
          <span>Manage Users</span>
        </button>
        <button class="tab" data-tab="test">
          <span>üß™</span>
          <span>Test APIs</span>
        </button>
        <button class="tab" data-tab="database">
          <span>üóÑÔ∏è</span>
          <span>Database Status</span>
        </button>
      </div>

      <!-- Director Setup Tab -->
      <div class="tab-content active" id="director-tab">
        <div class="card">
          <h2>Create Main Director Account</h2>
          <p class="info">This account will have full system access and control.</p>
          
          <form id="director-form">
            <div class="form-group">
              <label>Username</label>
              <input type="text" id="username" placeholder="director_admin" required>
            </div>

            <div class="form-group">
              <label>Password</label>
              <input type="password" id="password" placeholder="Enter password" required>
            </div>

            <button type="submit" class="btn-primary" id="create-director-btn">
              <span>Create Director Account</span>
              <span>‚Üí</span>
            </button>
          </form>

          <div id="director-result" class="result"></div>
        </div>
      </div>

      <!-- Manage Users Tab -->
      <div class="tab-content" id="users-tab">
        <div class="card">
          <h2>User Management</h2>
          <p class="info">View, create, and manage all users in the system</p>
          
          <!-- Filter -->
          <div class="user-filters">
            <button class="filter-btn active" data-role="all">All Users</button>
            <button class="filter-btn" data-role="director">Directors</button>
            <button class="filter-btn" data-role="admin">Admins</button>
            <button class="filter-btn" data-role="student">Students</button>
            <button class="btn-primary add-user-btn" onclick="openUserModal()">
              <span>+</span>
              <span>Create New User</span>
            </button>
          </div>

          <!-- Users List -->
          <div id="users-list" class="users-list">
            <div class="loading">Loading users...</div>
          </div>
        </div>
      </div>

      <!-- User Modal -->
      <div id="user-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
          <button class="modal-close" onclick="closeUserModal()">√ó</button>
          <div class="modal-header">
            <div class="modal-icon">üë§</div>
            <h2 id="modal-title">Create New User</h2>
            <p class="modal-subtitle">Fill in the details below</p>
          </div>
          
          <form id="user-modal-form" class="modal-form">
            <input type="hidden" id="edit-user-id" value="">
            
            <div class="form-grid">
              <div class="form-group">
                <label>
                  <span class="label-icon">üë§</span>
                  First Name <span class="required">*</span>
                </label>
                <input type="text" id="modal-first-name" placeholder="John" required>
              </div>
              <div class="form-group">
                <label>
                  <span class="label-icon">üë§</span>
                  Last Name <span class="required">*</span>
                </label>
                <input type="text" id="modal-last-name" placeholder="Doe" required>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label>
                  <span class="label-icon">üìß</span>
                  Username <span class="required">*</span>
                </label>
                <input type="text" id="modal-username" placeholder="johndoe" required>
              </div>
              <div class="form-group">
                <label>
                  <span class="label-icon">‚úâÔ∏è</span>
                  Email <span class="required">*</span>
                </label>
                <input type="email" id="modal-email" placeholder="john@example.com" required>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label>
                  <span class="label-icon">üîê</span>
                  Password <span class="required" id="password-required">*</span>
                </label>
                <input type="password" id="modal-password" placeholder="Enter password">
                <small id="password-hint" style="display: none;">Leave blank to keep current password</small>
              </div>
              <div class="form-group">
                <label>
                  <span class="label-icon">üé≠</span>
                  Role <span class="required">*</span>
                </label>
                <div class="custom-select" id="role-select">
                  <button type="button" class="select-trigger" onclick="toggleRoleDropdown()">
                    <span id="selected-role-text">üéì Student</span>
                    <span class="select-arrow">‚ñæ</span>
                  </button>
                  <div class="select-dropdown" id="role-dropdown">
                    <button type="button" class="select-option" data-value="student" onclick="selectRole('student', 'üéì Student')">
                      <span class="option-icon">üéì</span>
                      <span>Student</span>
                    </button>
                    <button type="button" class="select-option" data-value="admin" onclick="selectRole('admin', 'üõ°Ô∏è Admin')">
                      <span class="option-icon">üõ°Ô∏è</span>
                      <span>Admin</span>
                    </button>
                    <button type="button" class="select-option" data-value="director" onclick="selectRole('director', 'üëë Director')">
                      <span class="option-icon">üëë</span>
                      <span>Director</span>
                    </button>
                  </div>
                </div>
                <input type="hidden" id="modal-role" value="student" required>
              </div>
            </div>

            <div class="form-grid" id="modal-student-fields">
              <div class="form-group">
                <label>
                  <span class="label-icon">üÜî</span>
                  Student ID
                </label>
                <input type="text" id="modal-student-id" placeholder="STU-2024-001">
              </div>
              <div class="form-group">
                <label>
                  <span class="label-icon">üì±</span>
                  Phone
                </label>
                <input type="tel" id="modal-phone" placeholder="+1 234 567 8900">
              </div>
            </div>

            <div id="modal-result" class="modal-result"></div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancel</button>
              <button type="submit" class="btn-submit" id="modal-submit-btn">
                <span>Create User</span>
                <span class="submit-arrow">‚Üí</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Test APIs Tab -->
      <div class="tab-content" id="test-tab">
        <div class="card">
          <h2>API Testing</h2>
          <p class="info">Test your API endpoints and connections</p>

          <div class="api-tests">
            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/health">
                <span>üè•</span>
                <span>Health Check</span>
              </button>
              <div class="test-result" id="test-health"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/ping">
                <span>üì°</span>
                <span>Ping API</span>
              </button>
              <div class="test-result" id="test-ping"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" onclick="testSupabaseConnection()">
                <span>üóÑÔ∏è</span>
                <span>Supabase Connection</span>
              </button>
              <div class="test-result" id="test-supabase"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/auth/director/verify">
                <span>üîê</span>
                <span>Director Auth</span>
              </button>
              <div class="test-result" id="test-auth"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Database Status Tab -->
      <div class="tab-content" id="database-tab">
        <div class="card">
          <h2>Database Status</h2>
          <p class="info">Check Supabase connection and table status</p>

          <button class="btn-primary" onclick="checkDatabaseStatus()">
            <span>üîç</span>
            <span>Check Database</span>
          </button>

          <div id="database-status" class="database-status"></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>‚ö†Ô∏è <strong>Security Notice:</strong> This setup page should be removed or secured in production</p>
        <p>Access: <code>http://localhost:3000/setup.html</code></p>
      </div>
    </div>
  </div>

  <script>
    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${targetTab}-tab`).classList.add('active');
      });
    });

    // Director Account Creation
    document.getElementById('director-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('create-director-btn');
      const result = document.getElementById('director-result');
      
      btn.disabled = true;
      btn.innerHTML = '<span>Creating...</span><span>‚è≥</span>';
      result.innerHTML = '';
      
      const data = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      };
      
      try {
        const response = await fetch('/api/setup/director', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const resultData = await response.json();
        
        if (response.ok) {
          result.innerHTML = `
            <div class="success">
              <h3>‚úÖ Success!</h3>
              <p>${resultData.message}</p>
              <div class="director-info">
                <p><strong>Username:</strong> ${resultData.director.username}</p>
                <p><strong>Role:</strong> ${resultData.director.role}</p>
              </div>
              <a href="/Director" class="btn-link">Go to Director Login ‚Üí</a>
            </div>
          `;
          document.getElementById('director-form').reset();
        } else {
          throw new Error(resultData.error || 'Failed to create director account');
        }
      } catch (error) {
        result.innerHTML = `
          <div class="error">
            <h3>‚ùå Error</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Create Director Account</span><span>‚Üí</span>';
      }
    });

    // API Testing
    document.querySelectorAll('.btn-test').forEach(btn => {
      btn.addEventListener('click', async () => {
        const endpoint = btn.dataset.endpoint;
        if (!endpoint) return;
        
        // Find the sibling result div instead of using dynamic ID
        const resultDiv = btn.closest('.test-item').querySelector('.test-result');
        if (!resultDiv) return;
        
        resultDiv.innerHTML = '<div class="loading">Testing...</div>';
        
        try {
          const response = await fetch(endpoint);
          const data = await response.json();
          
          resultDiv.innerHTML = `
            <div class="test-success">
              <strong>Status:</strong> ${response.status} ${response.statusText}
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="test-error">
              <strong>Error:</strong> ${error.message}
            </div>
          `;
        }
      });
    });

    // Supabase Connection Test
    async function testSupabaseConnection() {
      const resultDiv = document.getElementById('test-supabase');
      resultDiv.innerHTML = '<div class="loading">Testing Supabase connection...</div>';
      
      try {
        // Test by checking if we can query users table
        const response = await fetch('/api/director/stats');
        
        if (response.ok) {
          const data = await response.json();
          resultDiv.innerHTML = `
            <div class="test-success">
              <strong>‚úÖ Supabase Connected</strong>
              <p>Successfully connected to database</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        } else {
          throw new Error('Failed to connect to Supabase');
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-error">
            <strong>‚ùå Connection Failed</strong>
            <p>${error.message}</p>
            <p>Check your environment variables:</p>
            <ul>
              <li>NEXT_PUBLIC_SUPABASE_URL</li>
              <li>SUPABASE_SERVICE_ROLE_KEY</li>
            </ul>
          </div>
        `;
      }
    }

    // Database Status Check
    async function checkDatabaseStatus() {
      const statusDiv = document.getElementById('database-status');
      statusDiv.innerHTML = '<div class="loading">Checking database status...</div>';
      
      try {
        const checks = [
          { name: 'Users Table', endpoint: '/api/director/users' },
          { name: 'Stats API', endpoint: '/api/director/stats' }
        ];
        
        let html = '<div class="status-grid">';
        
        for (const check of checks) {
          try {
            const response = await fetch(check.endpoint);
            const status = response.ok ? '‚úÖ' : '‚ùå';
            const statusClass = response.ok ? 'status-ok' : 'status-error';
            
            html += `
              <div class="status-item ${statusClass}">
                <span>${status}</span>
                <span>${check.name}</span>
                <span>${response.status}</span>
              </div>
            `;
          } catch (error) {
            html += `
              <div class="status-item status-error">
                <span>‚ùå</span>
                <span>${check.name}</span>
                <span>Failed</span>
              </div>
            `;
          }
        }
        
        html += '</div>';
        statusDiv.innerHTML = html;
        
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="error">
            <p>Error checking database: ${error.message}</p>
          </div>
        `;
      }
    }

    // User Management Functions
    let currentRole = 'all';
    let editingUserId = null;

    async function loadUsers(role = 'all') {
      currentRole = role;
      const listDiv = document.getElementById('users-list');
      listDiv.innerHTML = '<div class="loading">Loading users...</div>';
      
      try {
        const url = role === 'all' ? '/api/director/users' : `/api/director/users?role=${role}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to load users');
        
        const users = data.users || [];
        
        if (users.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><h3>No users found</h3><p>Create your first user to get started</p></div>';
          return;
        }
        
        let html = '<div class="users-grid">';
        users.forEach(user => {
          const roleIcon = { director: 'üëë', admin: 'üõ°Ô∏è', student: 'üéì' }[user.role] || 'üë§';
          const roleColor = { director: '#cba6f7', admin: '#89b4fa', student: '#a6e3a1' }[user.role] || '#cdd6f4';
          
          html += `
            <div class="user-card">
              <div class="user-header">
                <div class="user-info">
                  <h3>${roleIcon} ${user.first_name || ''} ${user.last_name || ''}</h3>
                  <span class="user-role" style="background: ${roleColor}15; color: ${roleColor}; border: 1px solid ${roleColor}35;">
                    ${user.role.toUpperCase()}
                  </span>
                </div>
                <div class="user-actions">
                  <button class="edit-btn" onclick="openEditModal('${user.id}')" title="Edit user">‚úèÔ∏è</button>
                  <button class="delete-btn" onclick="deleteUser('${user.id}', '${user.username}')" title="Delete user">üóëÔ∏è</button>
                </div>
              </div>
              <div class="user-details">
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                ${user.student_id ? `<p><strong>Student ID:</strong> ${user.student_id}</p>` : ''}
                ${user.phone ? `<p><strong>Phone:</strong> ${user.phone}</p>` : ''}
                <p><strong>Created:</strong> ${new Date(user.created_at).toLocaleDateString('en-GB')}</p>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        listDiv.innerHTML = html;
        
      } catch (error) {
        listDiv.innerHTML = `<div class="error"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
      }
    }

    // Modal Functions
    function openUserModal(user = null) {
      const modal = document.getElementById('user-modal');
      const form = document.getElementById('user-modal-form');
      const title = document.getElementById('modal-title');
      const submitBtn = document.getElementById('modal-submit-btn');
      const passwordField = document.getElementById('modal-password');
      const passwordRequired = document.getElementById('password-required');
      const passwordHint = document.getElementById('password-hint');
      
      // Reset form
      form.reset();
      document.getElementById('modal-result').innerHTML = '';
      document.getElementById('edit-user-id').value = '';
      editingUserId = null;
      
      // Reset role to student
      selectRole('student', 'üéì Student');
      
      if (user) {
        // Edit mode
        editingUserId = user.id;
        document.getElementById('edit-user-id').value = user.id;
        title.textContent = 'Edit User';
        submitBtn.innerHTML = '<span>Update User</span><span class="submit-arrow">‚Üí</span>';
        
        // Fill form
        document.getElementById('modal-first-name').value = user.first_name || '';
        document.getElementById('modal-last-name').value = user.last_name || '';
        document.getElementById('modal-username').value = user.username || '';
        document.getElementById('modal-email').value = user.email || '';
        document.getElementById('modal-student-id').value = user.student_id || '';
        document.getElementById('modal-phone').value = user.phone || '';
        
        // Set role
        const roleText = { student: 'üéì Student', admin: 'üõ°Ô∏è Admin', director: 'üëë Director' }[user.role] || 'üéì Student';
        selectRole(user.role, roleText);
        
        // Password optional for edit
        passwordField.required = false;
        passwordRequired.style.display = 'none';
        passwordHint.style.display = 'block';
      } else {
        // Create mode
        title.textContent = 'Create New User';
        submitBtn.innerHTML = '<span>Create User</span><span class="submit-arrow">‚Üí</span>';
        passwordField.required = true;
        passwordRequired.style.display = 'inline';
        passwordHint.style.display = 'none';
      }
      
      // Show modal with animation
      modal.style.display = 'flex';
      requestAnimationFrame(() => {
        modal.classList.add('active');
      });
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    function closeUserModal() {
      const modal = document.getElementById('user-modal');
      modal.classList.remove('active');
      
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }, 200);
    }

    async function openEditModal(userId) {
      try {
        const response = await fetch(`/api/director/users?role=all`);
        const data = await response.json();
        const user = data.users?.find(u => u.id === userId);
        
        if (user) {
          openUserModal(user);
        } else {
          alert('User not found');
        }
      } catch (error) {
        alert('Error loading user: ' + error.message);
      }
    }

    // Role dropdown functions
    function toggleRoleDropdown() {
      const dropdown = document.getElementById('role-dropdown');
      const isOpen = dropdown.classList.contains('open');
      
      if (isOpen) {
        dropdown.classList.remove('open');
      } else {
        dropdown.classList.add('open');
      }
    }

    function selectRole(value, text) {
      document.getElementById('modal-role').value = value;
      document.getElementById('selected-role-text').textContent = text;
      document.getElementById('role-dropdown').classList.remove('open');
      
      // Show/hide student fields
      const studentFields = document.getElementById('modal-student-fields');
      studentFields.style.display = value === 'student' ? 'grid' : 'none';
      
      // Update selected state
      document.querySelectorAll('.select-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.value === value);
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.custom-select')) {
        document.getElementById('role-dropdown')?.classList.remove('open');
      }
    });

    // Close modal on overlay click
    document.getElementById('user-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeUserModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeUserModal();
      }
    });

    // Form submission
    document.getElementById('user-modal-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const resultDiv = document.getElementById('modal-result');
      const submitBtn = document.getElementById('modal-submit-btn');
      const originalBtnText = submitBtn.innerHTML;
      
      submitBtn.innerHTML = '<span>Saving...</span><span class="spinner">‚è≥</span>';
      submitBtn.disabled = true;
      resultDiv.innerHTML = '';
      
      const role = document.getElementById('modal-role').value;
      const userData = {
        first_name: document.getElementById('modal-first-name').value,
        last_name: document.getElementById('modal-last-name').value,
        username: document.getElementById('modal-username').value,
        email: document.getElementById('modal-email').value,
        role: role
      };
      
      const password = document.getElementById('modal-password').value;
      if (password) {
        userData.password = password;
      }
      
      if (role === 'student') {
        userData.student_id = document.getElementById('modal-student-id').value;
        userData.phone = document.getElementById('modal-phone').value;
      }
      
      try {
        const isEdit = !!editingUserId;
        const url = isEdit ? `/api/director/users/${editingUserId}` : '/api/director/users';
        const method = isEdit ? 'PATCH' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to save user');
        
        resultDiv.innerHTML = `<div class="success"><p>‚úÖ ${isEdit ? 'User updated' : 'User created'} successfully!</p></div>`;
        
        // Close modal and reload after 1.5s
        setTimeout(() => {
          closeUserModal();
          loadUsers(currentRole);
        }, 1500);
        
      } catch (error) {
        resultDiv.innerHTML = `<div class="error"><p>‚ùå ${error.message}</p></div>`;
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/director/users/${userId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to delete user');
        
        loadUsers(currentRole);
        
      } catch (error) {
        alert(`Error deleting user: ${error.message}`);
      }
    }

    // Filter buttons for users
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadUsers(btn.dataset.role);
      });
    });

    // Auto-load users when Users tab is clicked
    document.querySelector('[data-tab="users"]')?.addEventListener('click', () => {
      loadUsers(currentRole);
    });
  </script>
</body>
</html>