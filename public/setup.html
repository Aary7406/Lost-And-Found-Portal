<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Director Setup Portal</title>
  <link rel="stylesheet" href="/setup.css">
</head>
<body>
  <div class="setup-page">
    <!-- Background -->
    <div class="background-gradient"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>

    <!-- Main Container -->
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="logo-pill">
          <span class="logo-icon">üîê</span>
          <span class="logo-text">Setup Portal</span>
        </div>
        <h1 class="title">Director Account Setup</h1>
        <p class="subtitle">Create the main director account for the Lost & Found system</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="director">
          <span>üë®‚Äçüíº</span>
          <span>Create Director</span>
        </button>
        <button class="tab" data-tab="users">
          <span>üë•</span>
          <span>Manage Users</span>
        </button>
        <button class="tab" data-tab="test">
          <span>üß™</span>
          <span>Test APIs</span>
        </button>
        <button class="tab" data-tab="database">
          <span>üóÑÔ∏è</span>
          <span>Database Status</span>
        </button>
      </div>

      <!-- Director Setup Tab -->
      <div class="tab-content active" id="director-tab">
        <div class="card">
          <h2>Create Main Director Account</h2>
          <p class="info">This account will have full system access and control.</p>
          
          <form id="director-form">
            <div class="form-group">
              <label>Username</label>
              <input type="text" id="username" placeholder="director_admin" required>
            </div>

            <div class="form-group">
              <label>Password</label>
              <input type="password" id="password" placeholder="Strong password" required minlength="8">
              <small>Minimum 8 characters</small>
            </div>

            <button type="submit" class="btn-primary" id="create-director-btn">
              <span>Create Director Account</span>
              <span>‚Üí</span>
            </button>
          </form>

          <div id="director-result" class="result"></div>
        </div>
      </div>

      <!-- Manage Users Tab -->
      <div class="tab-content" id="users-tab">
        <div class="card">
          <h2>User Management</h2>
          <p class="info">View, create, and manage all users in the system</p>
          
          <!-- Filter -->
          <div class="user-filters">
            <button class="filter-btn active" data-role="all">All Users</button>
            <button class="filter-btn" data-role="director">Directors</button>
            <button class="filter-btn" data-role="admin">Admins</button>
            <button class="filter-btn" data-role="student">Students</button>
            <button class="btn-primary" onclick="showCreateUserForm()">+ Create New User</button>
          </div>

          <!-- Users List -->
          <div id="users-list" class="users-list">
            <div class="loading">Loading users...</div>
          </div>

          <!-- Create User Form (Hidden by default) -->
          <div id="create-user-form" class="card" style="display: none; margin-top: 20px;">
            <h3>Create New User</h3>
            <form id="new-user-form">
              <div class="form-row">
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" id="new-first-name" required>
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" id="new-last-name" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Username *</label>
                  <input type="text" id="new-username" required>
                </div>
                <div class="form-group">
                  <label>Email *</label>
                  <input type="email" id="new-email" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Password *</label>
                  <input type="password" id="new-password" required minlength="6">
                </div>
                <div class="form-group">
                  <label>Role *</label>
                  <select id="new-role" required>
                    <option value="student">Student</option>
                    <option value="admin">Admin</option>
                    <option value="director">Director</option>
                  </select>
                </div>
              </div>

              <div class="form-row" id="student-fields">
                <div class="form-group">
                  <label>Student ID</label>
                  <input type="text" id="new-student-id">
                </div>
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" id="new-phone">
                </div>
              </div>

              <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn-primary">Create User</button>
                <button type="button" class="btn-test" onclick="hideCreateUserForm()">Cancel</button>
              </div>
            </form>
            <div id="create-user-result" class="result"></div>
          </div>
        </div>
      </div>

      <!-- Test APIs Tab -->
      <div class="tab-content" id="test-tab">
        <div class="card">
          <h2>API Testing</h2>
          <p class="info">Test your API endpoints and connections</p>

          <div class="api-tests">
            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/health">
                <span>üè•</span>
                <span>Health Check</span>
              </button>
              <div class="test-result" id="test-health"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/ping">
                <span>üì°</span>
                <span>Ping API</span>
              </button>
              <div class="test-result" id="test-ping"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" onclick="testSupabaseConnection()">
                <span>üóÑÔ∏è</span>
                <span>Supabase Connection</span>
              </button>
              <div class="test-result" id="test-supabase"></div>
            </div>

            <div class="test-item">
              <button class="btn-test" data-endpoint="/api/auth/director/verify">
                <span>üîê</span>
                <span>Director Auth</span>
              </button>
              <div class="test-result" id="test-auth"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Database Status Tab -->
      <div class="tab-content" id="database-tab">
        <div class="card">
          <h2>Database Status</h2>
          <p class="info">Check Supabase connection and table status</p>

          <button class="btn-primary" onclick="checkDatabaseStatus()">
            <span>üîç</span>
            <span>Check Database</span>
          </button>

          <div id="database-status" class="database-status"></div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>‚ö†Ô∏è <strong>Security Notice:</strong> This setup page should be removed or secured in production</p>
        <p>Access: <code>http://localhost:3000/setup.html</code></p>
      </div>
    </div>
  </div>

  <script>
    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`${targetTab}-tab`).classList.add('active');
      });
    });

    // Director Account Creation
    document.getElementById('director-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('create-director-btn');
      const result = document.getElementById('director-result');
      
      btn.disabled = true;
      btn.innerHTML = '<span>Creating...</span><span>‚è≥</span>';
      result.innerHTML = '';
      
      const data = {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      };
      
      try {
        const response = await fetch('/api/setup/director', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const resultData = await response.json();
        
        if (response.ok) {
          result.innerHTML = `
            <div class="success">
              <h3>‚úÖ Success!</h3>
              <p>${resultData.message}</p>
              <div class="director-info">
                <p><strong>Username:</strong> ${resultData.director.username}</p>
                <p><strong>Role:</strong> ${resultData.director.role}</p>
              </div>
              <a href="/Director" class="btn-link">Go to Director Login ‚Üí</a>
            </div>
          `;
          document.getElementById('director-form').reset();
        } else {
          throw new Error(resultData.error || 'Failed to create director account');
        }
      } catch (error) {
        result.innerHTML = `
          <div class="error">
            <h3>‚ùå Error</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Create Director Account</span><span>‚Üí</span>';
      }
    });

    // API Testing
    document.querySelectorAll('.btn-test').forEach(btn => {
      btn.addEventListener('click', async () => {
        const endpoint = btn.dataset.endpoint;
        if (!endpoint) return;
        
        // Find the sibling result div instead of using dynamic ID
        const resultDiv = btn.closest('.test-item').querySelector('.test-result');
        if (!resultDiv) return;
        
        resultDiv.innerHTML = '<div class="loading">Testing...</div>';
        
        try {
          const response = await fetch(endpoint);
          const data = await response.json();
          
          resultDiv.innerHTML = `
            <div class="test-success">
              <strong>Status:</strong> ${response.status} ${response.statusText}
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="test-error">
              <strong>Error:</strong> ${error.message}
            </div>
          `;
        }
      });
    });

    // Supabase Connection Test
    async function testSupabaseConnection() {
      const resultDiv = document.getElementById('test-supabase');
      resultDiv.innerHTML = '<div class="loading">Testing Supabase connection...</div>';
      
      try {
        // Test by checking if we can query users table
        const response = await fetch('/api/director/stats');
        
        if (response.ok) {
          const data = await response.json();
          resultDiv.innerHTML = `
            <div class="test-success">
              <strong>‚úÖ Supabase Connected</strong>
              <p>Successfully connected to database</p>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        } else {
          throw new Error('Failed to connect to Supabase');
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="test-error">
            <strong>‚ùå Connection Failed</strong>
            <p>${error.message}</p>
            <p>Check your environment variables:</p>
            <ul>
              <li>NEXT_PUBLIC_SUPABASE_URL</li>
              <li>SUPABASE_SERVICE_ROLE_KEY</li>
            </ul>
          </div>
        `;
      }
    }

    // Database Status Check
    async function checkDatabaseStatus() {
      const statusDiv = document.getElementById('database-status');
      statusDiv.innerHTML = '<div class="loading">Checking database status...</div>';
      
      try {
        const checks = [
          { name: 'Users Table', endpoint: '/api/director/users' },
          { name: 'Stats API', endpoint: '/api/director/stats' }
        ];
        
        let html = '<div class="status-grid">';
        
        for (const check of checks) {
          try {
            const response = await fetch(check.endpoint);
            const status = response.ok ? '‚úÖ' : '‚ùå';
            const statusClass = response.ok ? 'status-ok' : 'status-error';
            
            html += `
              <div class="status-item ${statusClass}">
                <span>${status}</span>
                <span>${check.name}</span>
                <span>${response.status}</span>
              </div>
            `;
          } catch (error) {
            html += `
              <div class="status-item status-error">
                <span>‚ùå</span>
                <span>${check.name}</span>
                <span>Failed</span>
              </div>
            `;
          }
        }
        
        html += '</div>';
        statusDiv.innerHTML = html;
        
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="error">
            <p>Error checking database: ${error.message}</p>
          </div>
        `;
      }
    }

    // User Management Functions
    let currentRole = 'all';

    async function loadUsers(role = 'all') {
      currentRole = role;
      const listDiv = document.getElementById('users-list');
      listDiv.innerHTML = '<div class="loading">Loading users...</div>';
      
      try {
        const url = role === 'all' ? '/api/director/users' : `/api/director/users?role=${role}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to load users');
        
        const users = data.users || [];
        
        if (users.length === 0) {
          listDiv.innerHTML = '<div class="info">No users found.</div>';
          return;
        }
        
        let html = '<div class="users-grid">';
        users.forEach(user => {
          const roleColor = {
            director: '#cba6f7',
            admin: '#89b4fa',
            student: '#a6e3a1'
          }[user.role] || '#cdd6f4';
          
          html += `
            <div class="user-card">
              <div class="user-header">
                <div class="user-info">
                  <h3>${user.first_name} ${user.last_name}</h3>
                  <span class="user-role" style="background: ${roleColor}20; color: ${roleColor}; border: 1px solid ${roleColor}40;">
                    ${user.role.toUpperCase()}
                  </span>
                </div>
                <button class="delete-btn" onclick="deleteUser('${user.id}', '${user.username}')" title="Delete user">
                  üóëÔ∏è
                </button>
              </div>
              <div class="user-details">
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                ${user.student_id ? `<p><strong>Student ID:</strong> ${user.student_id}</p>` : ''}
                ${user.phone ? `<p><strong>Phone:</strong> ${user.phone}</p>` : ''}
                <p><strong>Created:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        listDiv.innerHTML = html;
        
      } catch (error) {
        listDiv.innerHTML = `
          <div class="error">
            <p>Error loading users: ${error.message}</p>
          </div>
        `;
      }
    }

    function showCreateUserForm() {
      document.getElementById('create-user-form').style.display = 'block';
      document.getElementById('create-user-result').innerHTML = '';
    }

    function hideCreateUserForm() {
      document.getElementById('create-user-form').style.display = 'none';
      document.getElementById('new-user-form').reset();
      document.getElementById('create-user-result').innerHTML = '';
    }

    // Show/hide student fields based on role selection
    document.getElementById('new-role')?.addEventListener('change', (e) => {
      const studentFields = document.getElementById('student-fields');
      studentFields.style.display = e.target.value === 'student' ? 'flex' : 'none';
    });

    // Create new user
    document.getElementById('new-user-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const resultDiv = document.getElementById('create-user-result');
      resultDiv.innerHTML = '<div class="loading">Creating user...</div>';
      
      const role = document.getElementById('new-role').value;
      const userData = {
        first_name: document.getElementById('new-first-name').value,
        last_name: document.getElementById('new-last-name').value,
        username: document.getElementById('new-username').value,
        email: document.getElementById('new-email').value,
        password: document.getElementById('new-password').value,
        role: role
      };
      
      if (role === 'student') {
        userData.student_id = document.getElementById('new-student-id').value;
        userData.phone = document.getElementById('new-phone').value;
      }
      
      try {
        const response = await fetch('/api/director/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to create user');
        
        resultDiv.innerHTML = `
          <div class="success">
            <h3>‚úÖ User Created Successfully!</h3>
            <p>${userData.first_name} ${userData.last_name} (${userData.role}) has been added to the system.</p>
          </div>
        `;
        
        document.getElementById('new-user-form').reset();
        
        // Reload users list
        setTimeout(() => {
          hideCreateUserForm();
          loadUsers(currentRole);
        }, 2000);
        
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <h3>‚ùå Error</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    });

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/director/users/${userId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok) throw new Error(data.error || 'Failed to delete user');
        
        alert(`User "${username}" has been deleted successfully.`);
        loadUsers(currentRole);
        
      } catch (error) {
        alert(`Error deleting user: ${error.message}`);
      }
    }

    // Filter buttons for users
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadUsers(btn.dataset.role);
      });
    });

    // Auto-load users when Users tab is clicked
    document.querySelector('[data-tab="users"]')?.addEventListener('click', () => {
      loadUsers(currentRole);
    });
  </script>
</body>
</html>